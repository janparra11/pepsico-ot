{% extends "base.html" %}
{% block title %}Detalle OT {{ ot.folio }}{% endblock %}
{% block content %}

<style>
  .ficha-ot .fw-bold, .ficha-ot .fw-semibold { line-height: 1.5; }
</style>
<style>
  .ficha-ot {
    margin-bottom: 1.0rem; /* separa la ficha del siguiente bloque */
  }
</style>

{% load roles %}
<div class="bg-white p-4 rounded shadow-sm">
  <h1 class="h5 mb-3">OT {{ ot.folio }}</h1>

  <div class="mb-3">
  {% if request.user|has_role:"ASISTENTE_REPUESTO" or request.user|has_role:"JEFE_TALLER" or request.user|has_role:"ADMIN" %}
    <a class="btn btn-outline-primary btn-sm" href="{% url 'inv_mov_salida' %}?ot={{ ot.id }}">
      Agregar consumo de repuesto
    </a>
  {% endif %}
  </div>

    <!-- === FICHA ÚNICA DE LA OT (resumen completo) === -->
  <div class="card mb-5 border-0 shadow-sm">
    <div class="card-body bg-white">
      <h2 class="h6 text-muted mb-3">Ficha de la OT</h2>
      <div class="row g-4 align-items-start ficha-ot">

    <!-- Patente -->
    <div class="col-12 col-md-6 col-lg-3">
      <div class="p-3 border rounded bg-light-subtle h-100">
        <div class="text-muted small mb-1">Patente</div>
        <div class="fw-bold">{{ ot.vehiculo.patente }}</div>
      </div>
    </div>

    <!-- Chofer -->
    <div class="col-12 col-md-6 col-lg-3">
      <div class="p-3 border rounded bg-light-subtle h-100">
        <div class="text-muted small mb-1">Chofer</div>
        <div class="fw-bold">{{ ot.chofer|default:"—" }}</div>
      </div>
    </div>

    <!-- Tipo de vehículo -->
    <div class="col-12 col-md-6 col-lg-3">
      <div class="p-3 border rounded bg-light-subtle h-100">
        <div class="text-muted small mb-1">Tipo</div>
        <div class="fw-bold">{{ ot.vehiculo.tipo|default:"—" }}</div>
      </div>
    </div>

    <!-- Taller -->
    <div class="col-12 col-md-6 col-lg-3">
      <div class="p-3 border rounded bg-light-subtle h-100">
        <div class="text-muted small mb-1">Taller</div>
        <div class="fw-bold">{{ ot.taller.nombre }}</div>
      </div>
    </div>

    <!-- Estado actual -->
    <div class="col-12 col-md-6 col-lg-3">
      <div class="p-3 border rounded bg-light-subtle h-100">
        <div class="text-muted small mb-1">Estado actual</div>
        <span class="badge text-bg-info">{{ ot.get_estado_actual_display }}</span>
      </div>
    </div>

    <!-- Situación -->
    <div class="col-12 col-md-6 col-lg-3">
      <div class="p-3 border rounded bg-light-subtle h-100">
        <div class="text-muted small mb-1">Situación</div>
        {% if ot.activa %}
          <span class="badge text-bg-success">Activa</span>
        {% else %}
          <span class="badge text-bg-secondary">Cerrada</span>
        {% endif %}
      </div>
    </div>

    <!-- Ingreso -->
    <div class="col-12 col-md-6 col-lg-3">
      <div class="p-3 border rounded bg-light-subtle h-100">
        <div class="text-muted small mb-1">Ingreso</div>
        <div class="fw-semibold">{{ ot.fecha_ingreso|date:"d-m-Y H:i" }}</div>
      </div>
    </div>

    <!-- Cierre (si existe) -->
    {% if ot.fecha_cierre %}
    <div class="col-12 col-md-6 col-lg-3">
      <div class="p-3 border rounded bg-light-subtle h-100">
        <div class="text-muted small mb-1">Cierre</div>
        <div class="fw-semibold">{{ ot.fecha_cierre|date:"d-m-Y H:i" }}</div>
      </div>
    </div>
    {% endif %}

    <!-- Observaciones -->
    <div class="col-12">
      <div class="p-3 border rounded bg-light-subtle">
        <div class="text-muted small mb-1">Observaciones (ingreso)</div>
        <div>{{ historial.last.observaciones|default:"(sin observaciones)" }}</div>
      </div>
    </div>
  </div>
  <!-- === /FICHA === -->

<div class="row row-cols-1 row-cols-md-2 g-3 mb-4">

  <!-- Columna: Cambiar estado -->
  <div class="col">
    <div class="card card-body shadow-sm control-card">
      <h2 class="h6 mb-3">Cambiar estado</h2>

      {% if request.user|has_role:"MECANICO" or request.user|has_role:"JEFE_TALLER" or request.user|has_role:"ADMIN" %}
      {% if ot.activa %}
        <form method="post" action="{% url 'ot_cambiar_estado' ot.id %}">
          {% csrf_token %}
          <div class="mb-2">
            <select name="nuevo_estado" class="form-select">
              {% for value,label in estado_choices %}
                <option value="{{ value }}" {% if value == ot.estado_actual %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
          </div>
          <!-- Botón de ancho completo y misma altura -->
          <button class="btn btn-primary w-100 btn-action">Aplicar</button>
        </form>
        <div class="form-text mt-2">Solo se permiten transiciones válidas.</div>
      {% else %}
        <!-- Aviso gris igual al de Pausa cuando OT está cerrada -->
        <div class="alert alert-secondary mb-0">
          La OT está <strong>cerrada</strong> ({{ ot.fecha_cierre }}). No admite cambios.
        </div>
      {% endif %}
      {% endif %}
    </div>
  </div>

  <!-- Columna: Pausa -->
  {% if request.user|has_role:"MECANICO" or request.user|has_role:"ADMIN" %}
  <div class="col">
    <div class="card card-body shadow-sm control-card">
      <h2 class="h6 mb-3">Pausa</h2>

      {% if pausa_abierta %}
        <div class="alert alert-warning">
          <div><strong>Pausa abierta</strong></div>
          <div><strong>Motivo:</strong> {{ pausa_abierta.motivo }}</div>
          <div><strong>Desde:</strong> {{ pausa_abierta.inicio }}</div>
        </div>

        {% if ot.activa %}
          <form method="post" action="{% url 'pausa_finalizar' ot.id %}">
            {% csrf_token %}
            <input type="hidden" name="confirmar" value="on"/>
            <!-- Botón del mismo tamaño -->
            <button class="btn btn-danger w-100 btn-action">Finalizar pausa</button>
          </form>
        {% else %}
          <div class="alert alert-secondary mb-0">
            La OT está <strong>cerrada</strong>. No se pueden finalizar pausas aquí.
          </div>
        {% endif %}

      {% else %}
        {% if ot.activa %}
          <form method="post" action="{% url 'pausa_iniciar' ot.id %}">
            {% csrf_token %}
            <div class="mb-2">
              <input name="motivo" class="form-control" placeholder="Motivo (ej. Espera de repuesto)" required />
            </div>
            <!-- Botón del mismo tamaño -->
            <button class="btn btn-warning w-100 btn-action">Iniciar pausa</button>
          </form>
          <div class="form-text mt-2">Solo puede haber una pausa abierta a la vez.</div>
        {% else %}
          <!-- Mismo aviso gris cuando OT está cerrada -->
          <div class="alert alert-secondary mb-0">
            La OT está <strong>cerrada</strong>. No se pueden iniciar pausas.
          </div>
        {% endif %}
      {% endif %}
    </div>
  </div>
  {% endif %}
</div>

<div class="row row-cols-1 row-cols-md-2 g-3 mb-4">

  <!-- Prioridad de la OT -->
  <div class="col">
    <div class="card card-body shadow-sm control-card">
      <h2 class="h6 mb-3">Prioridad de la OT</h2>

      {% if ot.activa %}
        <form method="post" action="{% url 'ot_cambiar_prioridad' ot.id %}">
          {% csrf_token %}
          <div class="mb-2">
            {{ prioridad_form.prioridad }}
          </div>
          <button class="btn btn-primary w-100 py-2">Actualizar prioridad</button>
        </form>
      {% else %}
        <div class="alert alert-secondary mb-0">
          La OT está <strong>cerrada</strong> ({{ ot.fecha_cierre }}). No admite cambios.
        </div>
      {% endif %}

      <div class="mt-2">
        <span class="badge {% if ot.prioridad == 4 %}text-bg-danger{% elif ot.prioridad == 3 %}text-bg-warning{% elif ot.prioridad == 2 %}text-bg-info{% else %}text-bg-secondary{% endif %}">
          {{ ot.get_prioridad_display }}
        </span>
      </div>
    </div>
  </div>

  <!-- Estado del Vehículo -->
  <div class="col">
    <div class="card card-body shadow-sm control-card">
      <h2 class="h6 mb-3">Estado del vehículo</h2>

      <form method="post" action="{% url 'vehiculo_cambiar_estado' ot.id %}">
        {% csrf_token %}
        <div class="mb-2">
          {{ estado_veh_form.estado }}
        </div>
        <button class="btn btn-outline-primary w-100 py-2" {% if not ot.activa %}disabled{% endif %}>
          Actualizar estado de vehículo
        </button>
      </form>

      <div class="mt-2">
        <span class="badge {% if ot.vehiculo.estado == 'FUERA' %}text-bg-danger{% elif ot.vehiculo.estado == 'TALLER' %}text-bg-warning{% else %}text-bg-success{% endif %}">
          {{ ot.vehiculo.get_estado_display }}
        </span>
      </div>
    </div>
  </div>

</div>

<h2 class="h6 mt-4">Agendar evento</h2>
<div class="card card-body shadow-sm">
  <form method="post" action="{% url 'ot_agendar_evento' ot.id %}">
    {% csrf_token %}
    <div class="mb-2">{{ evento_form.titulo }}</div>
    <div class="mb-2">{{ evento_form.fecha }}</div>
    <button class="btn btn-primary w-100">Agendar</button>
  </form>
</div>

<h2 class="h6 mt-4">Agenda de esta OT</h2>
<div class="card card-body shadow-sm">
  {% if eventos_ot %}
    <ul class="list-group">
      {% for e in eventos_ot %}
        <li class="list-group-item d-flex justify-content-between align-items-start">
          <div>
            <div class="fw-semibold">{{ e.titulo }}</div>
            <div class="small text-muted">
              {{ e.inicio }}{% if e.fin %} – {{ e.fin }}{% endif %}
              {% if e.todo_el_dia %} · Todo el día{% endif %}
            </div>
          </div>
          <a class="btn btn-outline-secondary btn-sm" href="{% url 'core_agenda' %}">Ver calendario</a>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <div class="text-muted">Sin eventos agendados para esta OT.</div>
  {% endif %}
</div>


<h2 class="h6 mt-4">Documentos</h2>

<div class="row g-3">
  {% is_role 'RECEPCIONISTA' 'MECANICO' 'JEFE_TALLER' as can_docs %}
  {% if can_docs %}
  <div class="col-12 col-md-5">
    <div class="card card-body shadow-sm">
      <h3 class="h6">Subir documento</h3>
      {% if ot.activa %}
      <form method="post" action="{% url 'ot_subir_documento' ot.id %}" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="mb-2">
          {{ doc_form.archivo }}
          <div class="form-text">Permitidos: JPG, PNG, PDF. Máx: {{ settings.MAX_UPLOAD_MB }} MB.</div>
        </div>
        <div class="mb-2">
          {{ doc_form.tipo }}
        </div>
        <button class="btn btn-success w-100 py-2">Subir</button>
      </form>
      {% else %}
      <div class="alert alert-secondary mb-0">La OT está cerrada. No se pueden subir documentos.</div>
      {% endif %}
    </div>
  </div>
  {% endif %}

  <div class="col-12 col-md-7">
    <div class="card card-body shadow-sm">
      <h3 class="h6">Adjuntos</h3>
      {% if ot.documentos.all %}
        <div class="row g-3">
          {% for d in ot.documentos.all|dictsortreversed:"ts" %}
            <div class="col-12 col-sm-6">
              <div class="border rounded p-2 h-100">
                {% with nombre=d.archivo.url|lower %}
                  {% if ".jpg" in nombre or ".jpeg" in nombre or ".png" in nombre %}
                    <img src="{{ d.archivo.url }}" alt="Imagen" class="img-fluid rounded mb-2" />
                  {% elif ".pdf" in nombre %}
                    <div class="d-flex align-items-center gap-2 mb-2">
                      <span class="badge text-bg-secondary">PDF</span>
                      <a href="{{ d.archivo.url }}" target="_blank" rel="noopener">Abrir documento</a>
                    </div>
                  {% else %}
                    <a href="{{ d.archivo.url }}" target="_blank" rel="noopener">Descargar archivo</a>
                  {% endif %}
                {% endwith %}

                <div class="small text-muted mb-2">
                  {{ d.tipo|default:"(sin tipo)" }} · {{ d.ts }}
                </div>
                
                {% if request.user|has_role:"JEFE_TALLER" or request.user|has_role:"ADMIN" %}
                {% if ot.activa %}
                <form method="post" action="{% url 'ot_eliminar_documento' ot.id d.id %}">
                  {% csrf_token %}
                  <button class="btn btn-outline-danger btn-sm w-100">Eliminar</button>
                </form>
                {% else %}
                <div class="alert alert-secondary mb-0">OT cerrada · No se puede eliminar</div>
                {% endif %}
                {% endif %}
              </div>
            </div>
          {% empty %}
            <div class="text-muted">Sin documentos.</div>
          {% endfor %}
        </div>
      {% else %}
        <div class="text-muted">Sin documentos.</div>
      {% endif %}
    </div>
  </div>

  <div class="card card-body shadow-sm mb-3">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <div class="small text-muted">Mecánico asignado</div>
        <div class="fw-semibold">{{ ot.mecanico_asignado|default:"—" }}</div>
      </div>
      <div style="min-width:260px;">
      {% load roles %}
      {% if request.user|has_role:"JEFE_TALLER" or request.user|has_role:"SUPERVISOR" or request.user|has_role:"ADMIN" %}
        <form method="post" action="{% url 'ot_asignar_mecanico' ot.id %}">
          {% csrf_token %}
          <div class="input-group">
            {{ asignar_mec_form.mecanico }}
            <button class="btn btn-outline-primary">Asignar</button>
          </div>
        </form>
      {% endif %}
      </div>
    </div>
  </div>

  <div class="card card-body shadow-sm mb-3">
    <div class="row text-center">
      <div class="col">
        <div class="small text-muted">Duración total</div>
        <div class="fw-semibold">{{ ot.duracion_horas }} h</div>
      </div>
      <div class="col">
        <div class="small text-muted">Compromiso</div>
        <div class="fw-semibold">{{ ot.fecha_compromiso|default:"—" }}</div>
      </div>
      <div class="col">
        <div class="small text-muted">Atraso</div>
        <span class="badge {% if ot.esta_atrasada %}text-bg-danger{% else %}text-bg-success{% endif %}">
          {% if ot.esta_atrasada %}ATRASADA{% else %}OK{% endif %}
        </span>
      </div>
    </div>
  </div>

</div>

  <h2 class="h6 mt-4">Historial</h2>
  <ul class="list-group mb-3">
    {% for h in historial %}
      <li class="list-group-item d-flex justify-content-between">
        <span>{{ h.get_estado_display }} — desde {{ h.inicio }}{% if h.fin %} hasta {{ h.fin }}{% endif %}</span>
      </li>
    {% empty %}
      <li class="list-group-item">Sin historial.</li>
    {% endfor %}
  </ul>

  <h2 class="h6 mt-4">Pausas</h2>
  <ul class="list-group">
    {% for p in pausas %}
      <li class="list-group-item d-flex justify-content-between">
        <span>{{ p.motivo }} — desde {{ p.inicio }}{% if p.fin %} hasta {{ p.fin }}{% endif %}</span>
      </li>
    {% empty %}
      <li class="list-group-item">Sin pausas.</li>
    {% endfor %}
  </ul>

  <h3 class="h6 mt-4">Consumo de repuestos</h3>
  <div class="bg-white rounded shadow-sm">
    <table class="table align-middle mb-0">
      <thead>
        <tr>
          <th>Fecha</th>
          <th>Repuesto</th>
          <th class="text-end">Cantidad</th>
          <th>Motivo</th>
        </tr>
      </thead>
      <tbody>
        {% for m in ot.movimientos_repuesto.all %}
        <tr>
          <td class="text-nowrap">{{ m.creado_en|date:"d-m-Y H:i" }}</td>
          <td>{{ m.repuesto.codigo }} — {{ m.repuesto.descripcion }}</td>
          <td class="text-end">{{ m.cantidad|floatformat:"-2" }}</td>
          <td>{{ m.motivo|default:"—" }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="4" class="text-muted">Sin consumo asociado.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

</div>
{% endblock %}


