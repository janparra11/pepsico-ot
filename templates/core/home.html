{% extends "base.html" %}
{% load dict_extras %}
{% block title %}Inicio{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-start mb-3">
  <div>
    <h1 class="h5 mb-0">Bienvenido, {{ username }}</h1>
    <p class="text-muted small mb-0">{{ now|date:"j \\d\\e F \\d\\e Y" }}</p>
  </div>
{% load roles %}

{% is_role 'SUPERVISOR' 'JEFE_TALLER' 'ADMIN' as can_dashboard %}
{% if can_dashboard %}
  <a class="btn btn-outline-secondary" href="{% url 'ot_dashboard' %}">Ver Dashboard</a>
{% endif %}
</div>


  <!-- KPIs livianos -->
  <div class="row row-cols-2 row-cols-md-4 g-3 mb-4">
    <div class="col">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <div class="text-muted small">OTs activas</div>
          <div class="fs-4 fw-bold">{{ kpi_activas }}</div>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <div class="text-muted small">OTs en pausa</div>
          <div class="fs-4 fw-bold">{{ kpi_en_pausa }}</div>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <div class="text-muted small">OTs creadas hoy</div>
          <div class="fs-4 fw-bold">{{ kpi_creadas_hoy }}</div>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <div class="text-muted small">Notificaciones no leídas</div>
          <div class="fs-4 fw-bold">{{ notif_unread }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Accesos rápidos -->
  <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-3 mb-4">
    {% if can_registrar_ingreso %}
    <div class="col">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body d-flex flex-column">
          <h2 class="h6">Registrar ingreso</h2>
          <p class="text-muted small mb-3">Crear nueva OT.</p>
          <div class="mt-auto">
            
          {% is_role 'RECEPCIONISTA' 'GUARDIA' 'JEFE_TALLER' as can_ingresar %}
          {% if can_ingresar %}
            <a class="btn btn-primary" href="{% url 'ingreso_nuevo' %}">Nuevo ingreso</a>
          {% endif %}
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    {% if can_ver_ots %}
    <div class="col">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body d-flex flex-column">
          <h2 class="h6">Órdenes de Trabajo</h2>
          <p class="text-muted small mb-3">Listado con filtros y búsqueda.</p>
          <div class="mt-auto">
            <a class="btn btn-outline-primary w-100" href="{% url 'ot_lista' %}">Ver OTs</a>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    {% if can_ver_dashboard %}
    <div class="col">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body d-flex flex-column">
          <h2 class="h6">Dashboard</h2>
          <p class="text-muted small mb-3">KPIs y gráficos.</p>
          <div class="mt-auto">
            <a class="btn btn-outline-secondary w-100" href="{% url 'ot_dashboard' %}">Abrir Dashboard</a>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    {% if can_ver_notifs %}
    <div class="col">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body d-flex flex-column">
          <h2 class="h6">Notificaciones</h2>
          <p class="text-muted small mb-3">Eventos recientes de tus OTs.</p>
          <div class="mt-auto">
            <a class="btn btn-outline-secondary w-100" href="{% url 'core_notificaciones' %}">Ver Notificaciones</a>
          </div>
        </div>
      </div>
    </div>
    {% endif %}
  </div>

  <!-- Últimas 5 OTs y Notificaciones -->
  <div class="row g-3">
    <div class="col-12 col-lg-7">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <h5 class="mb-3">Últimas OTs</h5>
          {% if ultimas_ots %}
            <div class="list-group mb-4">
              {% for ot in ultimas_ots %}
                <a class="list-group-item list-group-item-action d-flex justify-content-between"
                  href="{% url 'ot_detalle' ot.id %}">
                  <span>#{{ ot.folio }} · {{ ot.vehiculo.patente }} · {{ ot.get_estado_actual_display }}</span>
                  <small class="text-muted">{{ ot.fecha_ingreso|date:"d/m/Y H:i" }}</small>
                </a>
              {% endfor %}
            </div>
          {% else %}
            <p class="text-muted">No hay OTs para tu perfil aún.</p>
          {% endif %}
          <div class="text-end"><a href="{% url 'ot_lista' %}" class="btn btn-link btn-sm">Ver todas</a></div>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-5">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <h2 class="h6 mb-3">Notificaciones recientes</h2>
          <ul class="list-group">
            {% for n in ultimas_notifs %}
              <li class="list-group-item d-flex justify-content-between align-items-start">
                <div>
                  <div class="fw-semibold">{{ n.titulo }}</div>
                  {% if n.mensaje %}<div class="small text-muted">{{ n.mensaje }}</div>{% endif %}
                  <div class="small text-muted">{{ n.creada_en }}</div>
                </div>
                <div>
                  {% if n.url %}<a class="btn btn-outline-secondary btn-sm" href="{{ n.url }}">Abrir</a>{% endif %}
                </div>
              </li>
            {% empty %}
              <li class="list-group-item text-muted">Sin notificaciones.</li>
            {% endfor %}
          </ul>
          <div class="text-end mt-2"><a href="{% url 'core_notificaciones' %}" class="btn btn-link btn-sm">Ver todas</a></div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
