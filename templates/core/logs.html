{% extends "base.html" %}
{% block title %}Bitácora y Sesiones{% endblock %}
{% block content %}
<div class="bg-white p-4 rounded shadow-sm">
  <h1 class="h5 mb-3">Bitácora y sesiones</h1>
  
  <!-- Filtros -->
  <form class="row g-2 mb-3" method="get">
    <div class="col-12 col-md-2">
      <label class="form-label small">Rango rápido</label>
      <select name="rango" class="form-select" onchange="this.form.submit()">
        <option value="">(Personalizado)</option>
        <option value="hoy"  {% if filtros.rango == 'hoy' %}selected{% endif %}>Hoy</option>
        <option value="ult7" {% if filtros.rango == 'ult7' %}selected{% endif %}>Últimos 7 días</option>
        <option value="mes"  {% if filtros.rango == 'mes' %}selected{% endif %}>Este mes</option>
      </select>
    </div>

    <div class="col-6 col-md-2">
      <label class="form-label small">Desde</label>
      <input type="date" name="fini" class="form-control" value="{{ filtros.fini }}">
    </div>
    <div class="col-6 col-md-2">
      <label class="form-label small">Hasta</label>
      <input type="date" name="ffin" class="form-control" value="{{ filtros.ffin }}">
    </div>
    <div class="col-6 col-md-2">
      <label class="form-label small">App</label>
      <select name="app" class="form-select">
        <option value="">(Todas)</option>
        {% for a in apps %}
          <option value="{{ a }}" {% if filtros.app == a %}selected{% endif %}>{{ a }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-6 col-md-2">
      <label class="form-label small">Acción</label>
      <select name="action" class="form-select">
        <option value="">(Todas)</option>
        {% for a in actions %}
          <option value="{{ a }}" {% if filtros.action == a %}selected{% endif %}>{{ a }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-6 col-md-2">
      <label class="form-label small">Usuario</label>
      <select name="user" class="form-select">
        <option value="">(Todos)</option>
        {% for u in users %}
          <option value="{{ u.id }}" {% if filtros.user|add:'0' == u.id|add:'0' %}selected{% endif %}>{{ u.username }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-6 col-md-2">
      <label class="form-label small">Objeto contiene</label>
      <input type="text" name="objq" class="form-control" value="{{ filtros.objq }}">
    </div>
    <div class="col-6 col-md-2">
      <label class="form-label small">Extra contiene</label>
      <input type="text" name="exq" class="form-control" value="{{ filtros.exq }}">
    </div>

    <div class="col-6 col-md-2">
      <label class="form-label small">Texto</label>
      <input type="text" name="q" class="form-control" value="{{ filtros.q }}" placeholder="objeto o extra...">
    </div>
    <div class="col-12 d-flex gap-2">
      <button class="btn btn-primary">Filtrar</button>
      <a class="btn btn-outline-secondary" href="?">Limpiar</a>
      <a class="btn btn-success" href="{% url 'core_logs_csv' %}?{{ request.GET.urlencode }}">Exportar CSV</a>
    </div>
  </form>

  <h2 class="h6">Eventos recientes</h2>
  <div class="table-responsive mb-2">
    <table class="table table-sm align-middle">
      <thead>
        <tr><th>Fecha</th><th>App</th><th>Acción</th><th>Usuario</th><th>Objeto</th><th>Extra</th></tr>
      </thead>
      <tbody>
        {% for l in logs_page.object_list %}
          <tr class="log-row" data-id="{{ l.id }}" style="cursor:pointer">
            <td class="text-nowrap">{{ l.ts|date:"d-m-Y H:i" }}</td>
            <td><span class="badge rounded-pill text-bg-light">{{ l.app }}</span></td>
            <td>
              {% if l.action == "LOGIN" or l.action == "CREATE" %}
                <span class="badge text-bg-success">{{ l.action }}</span>
              {% elif l.action == "LOGOUT" or l.action == "DELETE" %}
                <span class="badge text-bg-danger">{{ l.action }}</span>
              {% elif l.action == "UPDATE" %}
                <span class="badge text-bg-warning text-dark">{{ l.action }}</span>
              {% else %}
                <span class="badge text-bg-secondary">{{ l.action }}</span>
              {% endif %}
            </td>
            <td>{{ l.user|default:"—" }}</td>
            <td>{{ l.object_repr|default:"—" }}</td>
            <td class="small text-muted text-truncate" style="max-width:280px">{{ l.extra|default:"" }}</td>
          </tr>
        {% empty %}
          <tr><td colspan="6" class="text-muted">Sin eventos.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Paginador simple -->
  {% if logs_page.paginator.num_pages > 1 %}
  <nav aria-label="Paginación">
    <ul class="pagination pagination-sm">
      {% if logs_page.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?page={{ logs_page.previous_page_number }}">«</a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">«</span></li>
      {% endif %}

      <li class="page-item disabled">
        <span class="page-link">
          Página {{ logs_page.number }} / {{ logs_page.paginator.num_pages }}
        </span>
      </li>

      {% if logs_page.has_next %}
        <li class="page-item">
          <a class="page-link" href="?page={{ logs_page.next_page_number }}">»</a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">»</span></li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}
</div>

<!-- Modal Detalle -->
<div class="modal fade" id="logDetailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          Detalle del evento <span class="text-muted fw-normal" id="mdl-id"></span>
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div class="mb-2">
          <div class="small text-muted">Fecha</div>
          <div id="mdl-ts" class="fw-semibold"></div>
        </div>
        <div class="mb-2 d-flex gap-2">
          <div>
            <div class="small text-muted">App</div>
            <span id="mdl-app" class="badge text-bg-light"></span>
          </div>
          <div>
            <div class="small text-muted">Acción</div>
            <span id="mdl-action" class="badge text-bg-secondary"></span>
          </div>
          <div>
            <div class="small text-muted">Usuario</div>
            <span id="mdl-user" class="badge text-bg-info"></span>
          </div>
        </div>
        <div class="mb-3">
          <div class="small text-muted">Objeto</div>
          <div id="mdl-obj" class="fw-semibold"></div>
        </div>
        <div>
          <div class="d-flex align-items-center justify-content-between">
            <div class="small text-muted">Extra</div>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="btn-copy-extra">Copiar</button>
          </div>
          <pre id="mdl-extra" class="bg-light p-2 rounded border" style="white-space:pre-wrap; max-height:320px"></pre>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  const rows = document.querySelectorAll(".log-row");
  const modalEl = document.getElementById("logDetailModal");
  let modal;
  function badgeForAction(action){
    if (["LOGIN","CREATE"].includes(action)) return "badge text-bg-success";
    if (["LOGOUT","DELETE"].includes(action)) return "badge text-bg-danger";
    if (action === "UPDATE") return "badge text-bg-warning text-dark";
    return "badge text-bg-secondary";
  }
  rows.forEach(tr => {
    tr.addEventListener("click", async () => {
      const id = tr.dataset.id;
      try {
        const r = await fetch(`{% url 'core_logs_detail' 0 %}`.replace("/0/", `/${id}/`));
        if(!r.ok) throw new Error("No se pudo cargar el evento");
        const data = await r.json();

        document.getElementById("mdl-id").textContent = `#${data.id}`;
        document.getElementById("mdl-ts").textContent = data.ts;
        document.getElementById("mdl-app").textContent = data.app || "—";
        document.getElementById("mdl-action").textContent = data.action || "—";
        document.getElementById("mdl-action").className = badgeForAction(data.action || "");
        document.getElementById("mdl-user").textContent = data.user || "—";
        document.getElementById("mdl-obj").textContent = data.object_repr || "—";

        // pretty extra
        const pre = document.getElementById("mdl-extra");
        if (data.extra_is_json) {
          pre.textContent = JSON.stringify(data.extra_json, null, 2);
        } else {
          pre.textContent = data.extra_text || "";
        }

        // copiar
        document.getElementById("btn-copy-extra").onclick = async () => {
          try {
            await navigator.clipboard.writeText(pre.textContent || "");
            const old = pre.textContent;
            pre.textContent = "✓ Copiado al portapapeles\n\n" + old;
            setTimeout(()=> pre.textContent = old, 600);
          } catch (e) {}
        };

        // abrir modal (Bootstrap 5)
        modal = modal || new bootstrap.Modal(modalEl);
        modal.show();
      } catch (e) {
        alert(e.message);
      }
    });
  });
})();
</script>

{% endblock %}
