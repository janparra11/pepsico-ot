{% extends "base.html" %}
{% block title %}Agenda{% endblock %}

{% block content %}
<div class="bg-white p-4 rounded shadow-sm">
  <!-- Título + botones de vista -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h5 mb-0">Agenda</h1>
    <div class="btn-toolbar">
      <div class="btn-group me-2" role="group" aria-label="Cambiar vista">
        <button class="btn btn-sm" id="btnMonth">Mes</button>
        <button class="btn btn-sm" id="btnWeek">Semana</button>
        <button class="btn btn-sm" id="btnDay">Día</button>
      </div>
      <button class="btn btn-sm" id="btnNuevo">+ Nuevo</button>
    </div>
  </div>

  <!-- Calendario -->
  <div id="calendar" class="border rounded"></div>
</div>

<!-- MODAL crear/editar -->
<div class="modal fade" id="eventoModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="eventoForm">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">Evento</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="ev_id">
          <div class="mb-2">
            <label class="form-label">Título</label>
            <input class="form-control" id="titulo" required>
          </div>
          <div class="mb-2">
            <label class="form-label">Inicio</label>
            <input class="form-control" id="inicio" type="datetime-local" required>
          </div>
          <div class="mb-2">
            <label class="form-label">Fin</label>
            <input class="form-control" id="fin" type="datetime-local">
          </div>
          <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" id="todo_el_dia">
            <label class="form-check-label" for="todo_el_dia">Todo el día</label>
          </div>
          <div class="mb-2">
            <label class="form-label">OT (opcional, id numérico)</label>
            <input class="form-control" id="ot_id" type="number" min="1" placeholder="Ej: 12">
            <div class="form-text">Si lo completas, el evento quedará vinculado a esa OT.</div>
          </div>
          <div class="mb-2">
            <label class="form-label">Descripción</label>
            <textarea class="form-control" id="descripcion" rows="3"></textarea>
          </div>
        </div>
        <div class="modal-footer d-flex justify-content-between">
          <button type="button" class="btn btn-outline-danger" id="btnEliminar" style="display:none">Eliminar</button>
          <div>
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-primary" id="btnGuardar">Guardar</button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- FullCalendar -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/main.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/locales-all.global.min.js"></script>

<!-- Estilos -->
<style>
  /* ===== Botones superiores (Mes / Semana / Día) ===== */
  #btnMonth,
  #btnWeek,
  #btnDay {
    background-color: #ffffff;
    color: #004B93;
    border: 1px solid #004B93;
    border-radius: 6px;
    padding-inline: 14px;
    font-size: 0.9rem;
    font-weight: 500;
    box-shadow: 0 2px 3px rgba(0,0,0,0.08);
  }

  #btnMonth:hover,
  #btnWeek:hover,
  #btnDay:hover {
    background-color: #e3f0ff;
    color: #00356d;
  }

  /* botón activo (nuestros Mes / Semana / Día) */
  .btn-view-active {
    background-color: #004B93 !important;
    color: #ffffff !important;
  }

  /* Botón + Nuevo */
  #btnNuevo {
    background-color: #ff8c00;
    color: #ffffff;
    border: 1px solid #ff8c00;
    border-radius: 6px;
    font-size: 0.9rem;
    font-weight: 600;
    box-shadow: 0 2px 3px rgba(0,0,0,0.12);
  }

  #btnNuevo:hover {
    background-color: #e17a00;
    border-color: #e17a00;
  }

  /* ===== Botones de FullCalendar (flechas + Hoy) ===== */
  /* Forzamos colores con !important para ganar a los estilos por defecto */
  #calendar .fc .fc-button-primary {
    background-color: #ffffff !important;
    color: #004B93 !important;
    border: 1px solid #004B93 !important;
    border-radius: 6px;
    font-size: 0.85rem;
    font-weight: 500;
    box-shadow: 0 2px 3px rgba(0,0,0,0.08);
  }

  #calendar .fc .fc-button-primary:hover {
    background-color: #e3f0ff !important;
    color: #00356d !important;
  }

  #calendar .fc .fc-button-primary:not(:disabled).fc-button-active,
  #calendar .fc .fc-button-primary:not(:disabled):active {
    background-color: #004B93 !important;
    color: #ffffff !important;
  }

 /* ===== Eventos: fondo suave + colores por tipo ===== */

/* Estilo base de todos los eventos */
#calendar .fc-event {
  border-radius: 6px;
  border: 1px solid #0d6efd !important;
  background-color: #e7f0ff !important;  /* azul muy clarito */
}

#calendar .fc-event .fc-event-main {
  color: #0d6efd !important;
  padding: 1px 3px;
  font-size: 0.75rem;
  font-weight: 500;
}

/* Vista semana/día: un poquito más legible */
#calendar .fc-timegrid-event .fc-event-main {
  font-size: 0.8rem;
}

/* Tipo: ENTREGAS (naranja) */
#calendar .fc-event.ev-entrega {
  border-color: #fd7e14 !important;
  background-color: #ffe6cc !important;   /* naranja clarito */
}
#calendar .fc-event.ev-entrega .fc-event-main {
  color: #c25a00 !important;
}

/* Tipo: REVISIONES (verde) */
#calendar .fc-event.ev-revision {
  border-color: #198754 !important;
  background-color: #d8f3df !important;   /* verde clarito */
}
#calendar .fc-event.ev-revision .fc-event-main {
  color: #13653f !important;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const el = document.getElementById('calendar');

  const calendar = new FullCalendar.Calendar(el, {
    initialView: 'dayGridMonth',   // Vista por defecto: mes
    locale: 'es',
    firstDay: 1,
    timeZone: 'local',
    buttonText: {
      today: 'Hoy',
      month: 'Mes',
      week: 'Semana',
      day: 'Día'
    },
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: ''        // sin botones de vista internos
    },
    events: '{% url "core_agenda_api" %}',
    selectable: true,
    selectMirror: true,
    slotMinTime: "07:00:00",
    slotMaxTime: "20:00:00",
    expandRows: true,
    eventTimeFormat: { hour: '2-digit', minute: '2-digit' },
    height: 'auto',
    nowIndicator: true,
    navLinks: true,

    /* Colorear eventos según título / descripción */
    eventDidMount: function(info) {
      const title = (info.event.title || "").toLowerCase();
      const desc  = (info.event.extendedProps.descripcion || "").toLowerCase();
      const text  = title + " " + desc;

      if (text.includes("ingreso")) {
        info.el.classList.add("ev-ingreso");
      } else if (text.includes("entrega")) {
        info.el.classList.add("ev-entrega");
      } else if (text.includes("revision") || text.includes("revisión")) {
        info.el.classList.add("ev-revision");
      }
    },

    select: function(info) {
      abrirModalCrear(info.start, info.end);
      calendar.unselect();
    },

    eventClick: function(info) {
      info.jsEvent.preventDefault();
      abrirModalEditar(info.event);
    }
  });

  calendar.render();

  // -------- Botones de vista (Mes / Semana / Día) --------
  const btnMonth = document.getElementById('btnMonth');
  const btnWeek  = document.getElementById('btnWeek');
  const btnDay   = document.getElementById('btnDay');

  function marcarActivo(btn) {
    [btnMonth, btnWeek, btnDay].forEach(b => b.classList.remove('btn-view-active'));
    btn.classList.add('btn-view-active');
  }

  btnMonth.onclick = () => {
    calendar.changeView('dayGridMonth');
    marcarActivo(btnMonth);
  };

  btnWeek.onclick = () => {
    calendar.changeView('timeGridWeek');
    marcarActivo(btnWeek);
  };

  btnDay.onclick = () => {
    calendar.changeView('timeGridDay');
    marcarActivo(btnDay);
  };

  // Dejamos "Mes" como activa al cargar
  marcarActivo(btnMonth);

  // Botón + Nuevo
  document.getElementById('btnNuevo').onclick = () => abrirModalCrear();

  // -------- Modal y CRUD --------
  const modalEl = document.getElementById('eventoModal');
  const modal = new bootstrap.Modal(modalEl);
  const form  = document.getElementById('eventoForm');
  const evId  = document.getElementById('ev_id');
  const titulo= document.getElementById('titulo');
  const inicio= document.getElementById('inicio');
  const fin   = document.getElementById('fin');
  const todo  = document.getElementById('todo_el_dia');
  const otId  = document.getElementById('ot_id');
  const desc  = document.getElementById('descripcion');
  const btnEliminar = document.getElementById('btnEliminar');

  function toLocalInput(dt) {
    if (!dt) return "";
    const d = new Date(dt);
    d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
    return d.toISOString().slice(0,16);
  }

  function abrirModalCrear(start=null, end=null) {
    document.getElementById('modalTitle').innerText = "Nuevo evento";
    evId.value = "";
    titulo.value = "";
    inicio.value = start ? toLocalInput(start) : "";
    fin.value = end ? toLocalInput(end) : "";
    todo.checked = false;
    otId.value = "";
    desc.value = "";
    btnEliminar.style.display = "none";
    modal.show();
  }

  function abrirModalEditar(event) {
    document.getElementById('modalTitle').innerText = "Editar evento";
    evId.value = event.id;
    titulo.value = event.title || "";
    inicio.value = toLocalInput(event.start);
    fin.value = event.end ? toLocalInput(event.end) : "";
    todo.checked = event.allDay || false;
    otId.value = (event.extendedProps && event.extendedProps.ot_id) ? event.extendedProps.ot_id : "";
    desc.value = (event.extendedProps && event.extendedProps.descripcion) ? event.extendedProps.descripcion : "";
    btnEliminar.style.display = "inline-block";
    modal.show();
  }

  // guardar (create / update)
  form.onsubmit = async function(e) {
    e.preventDefault();
    const payload = {
      titulo: titulo.value.trim(),
      inicio: inicio.value ? new Date(inicio.value).toISOString() : "",
      fin: (todo.checked || !fin.value) ? "" : new Date(fin.value).toISOString(),
      todo_el_dia: todo.checked,
      ot_id: otId.value ? parseInt(otId.value, 10) : null,
      descripcion: desc.value || ""
    };

    let resp;
    if (evId.value) {
      // update
      resp = await fetch(`{% url "core_agenda_detalle_api" 0 %}`.replace('/0/', `/${evId.value}/`), {
        method: "PUT",
        headers: {"Content-Type":"application/json", "X-CSRFToken": "{{ csrf_token }}"},
        body: JSON.stringify(payload)
      });
    } else {
      // create
      resp = await fetch("{% url 'core_agenda_crear_api' %}", {
        method: "POST",
        headers: {"Content-Type":"application/json", "X-CSRFToken": "{{ csrf_token }}"},
        body: JSON.stringify(payload)
      });
    }

    if (resp.ok) {
      modal.hide();
      calendar.refetchEvents();
    } else {
      const data = await resp.json().catch(()=>({}));
      alert(data.error || "Error al guardar");
    }
  };

  // eliminar
  btnEliminar.onclick = async function() {
    if (!evId.value) return;
    if (!confirm("¿Eliminar este evento?")) return;
    const resp = await fetch(`{% url "core_agenda_detalle_api" 0 %}`.replace('/0/', `/${evId.value}/`), {
      method: "DELETE",
      headers: {"X-CSRFToken": "{{ csrf_token }}"}
    });
    if (resp.ok) {
      modal.hide();
      calendar.refetchEvents();
    } else {
      alert("No se pudo eliminar");
    }
  };
});
</script>
{% endblock %}
