{% load static %}
{% load roles %}

<nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
  <div class="container">

    {# Marca / logo #}
    <a class="navbar-brand d-flex align-items-center" href="{% url 'home' %}">
      <img src="{% static 'img/pepsico-logo.png' %}" alt="PepsiCo">
    </a>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarNav">
      {% with request.resolver_match.url_name as url_name %}

      <ul class="navbar-nav me-auto mb-2 mb-lg-0">

        {# Inicio #}
        <li class="nav-item">
          <a class="nav-link {% if url_name == 'home' %}active border-bottom border-2{% endif %}"
             href="{% url 'home' %}">
            Inicio
          </a>
        </li>

        {# Usuarios (solo ADMIN) #}
        {% if request.user|has_role:"ADMIN" %}
          <li class="nav-item">
            <a class="nav-link {% if url_name == 'users_admin_list' %}active border-bottom border-2{% endif %}"
               href="{% url 'users_admin_list' %}">
              Usuarios
            </a>
          </li>
        {% endif %}

        {# Configuraci贸n (Supervisor / Jefe Taller / Admin) #}
        {% if request.user|has_role:"SUPERVISOR" or request.user|has_role:"JEFE_TALLER" or request.user|has_role:"ADMIN" %}
          <li class="nav-item">
            <a class="nav-link {% if url_name == 'core_config' %}active border-bottom border-2{% endif %}"
               href="{% url 'core_config' %}">
              Configuraci贸n
            </a>
          </li>
        {% endif %}

        {# Dashboard #}
        {% if request.user|has_role:"SUPERVISOR" or request.user|has_role:"JEFE_TALLER" or request.user|has_role:"ADMIN" %}
          <li class="nav-item">
            <a class="nav-link {% if url_name == 'ot_dashboard' %}active border-bottom border-2{% endif %}"
               href="{% url 'ot_dashboard' %}">
              Dashboard
            </a>
          </li>
        {% endif %}

        {# Reportes #}
        {% if request.user|has_role:"SUPERVISOR" or request.user|has_role:"JEFE_TALLER" or request.user|has_role:"ADMIN" %}
          <li class="nav-item">
            <a class="nav-link {% if url_name == 'reportes_dashboard' %}active border-bottom border-2{% endif %}"
               href="{% url 'reportes_dashboard' %}">
              Reportes
            </a>
          </li>
        {% endif %}

        {# Inventario + Movimientos (Asistente, Jefe Taller, Admin, Supervisor) #}
        {% if request.user|has_role:"ASISTENTE_REPUESTO" or request.user|has_role:"JEFE_TALLER" or request.user|has_role:"ADMIN" or request.user|has_role:"SUPERVISOR" %}
          <li class="nav-item">
            <a class="nav-link {% if url_name == 'inv_repuesto_list' %}active border-bottom border-2{% endif %}"
               href="{% url 'inv_repuesto_list' %}">
              Inventario
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link {% if url_name == 'inv_mov_list' %}active border-bottom border-2{% endif %}"
               href="{% url 'inv_mov_list' %}">
              Movimientos
            </a>
          </li>
        {% endif %}

        {# OTs: s贸lo mostramos "Mis OTs" para mec谩nico #}
        {% is_role 'RECEPCIONISTA' 'GUARDIA' 'JEFE_TALLER' 'MECANICO' 'ASISTENTE_REPUESTO' 'SUPERVISOR' as can_ver_ots %}
        {% if can_ver_ots %}
          {% if request.user|has_role:"MECANICO" %}
            <li class="nav-item">
              <a class="nav-link {% if url_name == 'ot_lista' %}active border-bottom border-2{% endif %}"
                 href="{% url 'ot_lista' %}?mis=1">
                Mis OTs
              </a>
            </li>
          {% endif %}
        {% endif %}

        {# Ingresos: Recepcionista / Guardia / Jefe Taller / Admin #}
        {% is_role 'RECEPCIONISTA' 'GUARDIA' 'JEFE_TALLER' 'ADMIN' as can_ingresar %}
        {% if can_ingresar %}
          <li class="nav-item">
            <a class="nav-link {% if url_name == 'ingreso_nuevo' %}active border-bottom border-2{% endif %}"
              href="{% url 'ingreso_nuevo' %}">
              Ingresos
            </a>
          </li>
        {% endif %}

        {# Agenda #}
        {% is_role 'RECEPCIONISTA' 'GUARDIA' 'JEFE_TALLER' 'MECANICO' 'ASISTENTE_REPUESTO' 'SUPERVISOR' as can_agenda %}
        {% if can_agenda %}
          <li class="nav-item">
            <a class="nav-link {% if url_name == 'core_agenda' %}active border-bottom border-2{% endif %}"
               href="{% url 'core_agenda' %}">
              Agenda
            </a>
          </li>
        {% endif %}

      </ul>

      {# Lado derecho: notificaciones, reloj, usuario #}
      <ul class="navbar-nav ms-auto align-items-center">

        {% if request.user.is_authenticated %}
          {# Notificaciones #}
          <li class="nav-item dropdown me-3">
            <a class="nav-link dropdown-toggle position-relative text-light"
               href="#" id="notifDropdown"
               role="button" data-bs-toggle="dropdown" aria-expanded="false">
              
              {% if notif_unread|add:0 > 0 %}
                <span id="notif-badge"
                      class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                  {{ notif_unread }}
                </span>
              {% else %}
                <span id="notif-badge"
                      class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none">
                  0
                </span>
              {% endif %}
            </a>
            <ul class="dropdown-menu dropdown-menu-end shadow"
                aria-labelledby="notifDropdown"
                style="min-width: 340px;">
              <li class="dropdown-header d-flex justify-content-between align-items-center">
                <span>Notificaciones</span>
                <a class="small" href="{% url 'core_notificaciones' %}">Ver todas</a>
              </li>
              <li><hr class="dropdown-divider"></li>

              {% if notif_latest %}
                {% for n in notif_latest %}
                  <li>
                    <a class="dropdown-item d-flex justify-content-between align-items-start"
                      href="{% url 'core_notificacion_detalle' n.id %}">
                      <div class="me-2">
                        <div class="fw-semibold">{{ n.titulo }}</div>
                        {% if n.mensaje %}
                          <div class="small text-muted">
                            {{ n.mensaje|truncatechars:60 }}
                          </div>
                        {% endif %}
                        <div class="small text-muted">{{ n.creada_en }}</div>
                      </div>
                      {% if not n.leida %}
                        <span class="badge text-bg-primary">Nueva</span>
                      {% endif %}
                    </a>
                  </li>
                {% endfor %}
              {% else %}
                <li>
                  <span class="dropdown-item-text text-muted">Sin notificaciones a煤n.</span>
                </li>
              {% endif %}
            </ul>
          </li>

          {# Reloj #}
          <li class="nav-item me-3">
            <span class="text-light small" id="clock"></span>
          </li>

          {# Usuario #}
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle text-light" href="#"
               role="button" data-bs-toggle="dropdown" aria-expanded="false">
              {{ request.user.username|capfirst }}
            </a>
            <ul class="dropdown-menu dropdown-menu-end shadow">
              <li>
                <span class="dropdown-item disabled">
                  Rol: {{ request.user.perfil.get_rol_display|default:"(sin rol)" }}
                </span>
              </li>
              <li><a class="dropdown-item" href="{% url 'password_change' %}">Cambiar contrase帽a</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="{% url 'logout' %}">Salir</a></li>
            </ul>
          </li>

        {% else %}
          {# Cuando no hay sesi贸n #}
          <li class="nav-item">
            <a class="nav-link" href="{% url 'login' %}">Iniciar sesi贸n</a>
          </li>
        {% endif %}
      </ul>

      {% endwith %}
    </div>
  </div>
</nav>
