{% extends "base.html" %}
{% load humanize %}
{% block title %}Reportes y Supervisión{% endblock %}
{% block content %}
<div class="bg-white p-4 rounded shadow-sm">
  <h1 class="h5 mb-3">Reportes y Supervisión <span class="text-muted">· {{ cfg.nombre_taller }}</span></h1>

  <!-- Filtros -->
  <form class="row g-2 mb-3" method="get">

    <div class="col-12 col-md-3">
      <label class="form-label small">Rango rápido</label>
      <select name="rango" id="filtro-rango" class="form-select">
        <option value="" {% if not filtros.rango %}selected{% endif %}>(Personalizado)</option>
        <option value="hoy"  {% if filtros.rango == 'hoy' %}selected{% endif %}>Hoy</option>
        <option value="ult7" {% if filtros.rango == 'ult7' %}selected{% endif %}>Últimos 7 días</option>
        <option value="mes"  {% if filtros.rango == 'mes' %}selected{% endif %}>Este mes</option>
      </select>
    </div>

    <div class="col-6 col-md-2">
      <label class="form-label small">Desde</label>
      <input type="date" name="fini" class="form-control" value="{{ filtros.fini }}">
    </div>
    <div class="col-6 col-md-2">
      <label class="form-label small">Hasta</label>
      <input type="date" name="ffin" class="form-control" value="{{ filtros.ffin }}">
    </div>
    <div class="col-6 col-md-2">
      <label class="form-label small">Estado</label>
      <select name="estado" class="form-select">
        <option value="">(Todos)</option>
        {% for val,label in estados %}
          <option value="{{ val }}" {% if filtros.estado == val %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </div>

      <!-- <div class="col-6 col-md-2">
      <label class="form-label small">Métrica vehículos</label>
      <select name="veh_metric" class="form-select">
        <option value="ots" {% if filtros.veh_metric == 'ots' or not filtros.veh_metric %}selected{% endif %}>OTs</option>
        <option value="cerradas" {% if filtros.veh_metric == 'cerradas' %}selected{% endif %}>OTs cerradas</option>
      </select>
    </div>-->

    <div class="col-6 col-md-2">
      <label class="form-label small">Taller</label>
      <select name="taller" class="form-select">
        <option value="">(Todos)</option>
        {% for t in talleres %}
          <option value="{{ t.id }}" {% if filtros.taller|add:'0' == t.id|add:'0' %}selected{% endif %}>{{ t.nombre }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-12 col-md-2">
      <label class="form-label small">Mecánico</label>
      <select name="mecanico" class="form-select">
        <option value="">(Todos)</option>
        {% for u in mecanicos %}
          <option value="{{ u.id }}" {% if filtros.mecanico|add:'0' == u.id|add:'0' %}selected{% endif %}>{{ u.username }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-12 d-flex gap-2">
      <button class="btn btn-primary btn-action btn-wide">Filtrar</button>
      <a class="btn btn-outline-secondary" href="?">Limpiar</a>
      <a class="btn btn-success ms-auto" href="{% url 'reportes_export_excel' %}?{{ request.GET.urlencode }}">Exportar Excel</a>
      <a class="btn btn-outline-dark" href="{% url 'reportes_export_pdf' %}?{{ request.GET.urlencode }}">Exportar PDF</a>
    </div>
  </form>

  <!-- KPIs -->
  <div class="row g-3 mb-3">
    <div class="col-12 col-md-3">
      <div class="p-3 border rounded bg-light-subtle">
        <div class="small text-muted">OTs abiertas</div>
        <div class="display-6">{{ kpi_abiertas|intcomma }}</div>
      </div>
    </div>
    <div class="col-12 col-md-3">
      <div class="p-3 border rounded bg-light-subtle">
        <div class="small text-muted">OTs cerradas</div>
        <div class="display-6">{{ kpi_cerradas|intcomma }}</div>
      </div>
    </div>
    <div class="col-12 col-md-3">
      <div class="p-3 border rounded bg-light-subtle">
        <div class="small text-muted">Tiempo prom. reparación (pantalla)</div>
        <div class="display-6">{{ kpi_tiempo_prom|floatformat:"-2" }} h</div>
      </div>
    </div>
    <div class="col-12 col-md-3">
      <div class="p-3 border rounded bg-light-subtle">
        <div class="small text-muted">MTTR (cerradas válidas)</div>
        <div class="display-6">{{ kpi_mttr|floatformat:"-2" }} h</div>
      </div>
    </div>
    <div class="col-12 col-md-3">
      <div class="p-3 border rounded bg-light-subtle">
        <div class="small text-muted">SLA (≤ {{ sla_objetivo }} h)</div>
        <div class="display-6">{{ sla_pct }}%</div>
        <div class="small text-muted">{{ sla_dentro }}/{{ sla_total }} dentro de SLA</div>
      </div>
    </div>

    <div class="col-12 col-md-3">
      <div class="p-3 border rounded bg-light-subtle">
        <div class="small text-muted">Tiempo prom. reparación</div>
        <div class="display-6">{{ kpi_tiempo_prom|floatformat:"-2" }} h</div>
      </div>
    </div>

    <!-- NEW: KPI Vencidas -->
    <div class="col-12 col-md-3">
      <div class="p-3 border rounded {% if kpi_vencidas > 0 %}bg-danger-subtle{% else %}bg-light-subtle{% endif %}">
        <div class="small text-muted">OTs vencidas (SLA {{ cfg.sla_horas }} h)</div>
        <div class="display-6">
          <span class="{% if kpi_vencidas > 0 %}text-danger{% endif %}">
            {{ kpi_vencidas|intcomma }}
          </span>
        </div>
      </div>
    </div>
  </div>

    <div class="row g-4 mb-4 align-items-stretch">
        <!-- === Sección: Tops === -->
        <div class="col-12 col-lg-6">
          <div class="card card-body">
            <h2 class="h6 mb-3">Top 20 repuestos por consumo</h2>
            <table class="table table-sm align-middle mb-0">
              <thead>
                <tr>
                  <th>Código</th>
                  <th>Descripción</th>
                  <th class="text-end">Cantidad</th>
                </tr>
              </thead>
              <tbody>
                {% for r in top_repuestos %}
                  <tr>
                    <td>{{ r.repuesto__codigo }}</td>
                    <td>{{ r.repuesto__descripcion }}</td>
                    <td class="text-end">{{ r.total|floatformat:2 }}</td>
                  </tr>
                {% empty %}
                  <tr><td colspan="3" class="text-muted">Sin datos.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        <div class="col-12 col-lg-6">
          <div class="card card-body">
            <h2 class="h6 mb-3">MTTR por mecánico (Top 10)</h2>
            <table class="table table-sm align-middle mb-0">
              <thead>
                <tr>
                  <th>Mecánico</th>
                  <th class="text-end">MTTR (h)</th>
                </tr>
              </thead>
              <tbody>
                {% for user, h in mttr_mecanicos %}
                  <tr>
                    <td>{{ user }}</td>
                    <td class="text-end">
                      {% if h %}{{ h|floatformat:"-2" }}{% else %}—{% endif %}
                    </td>
                  </tr>
                {% empty %}
                  <tr><td colspan="2" class="text-muted">Sin datos.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        <div class="col-12 col-lg-6">
          <div class="card card-body">
            <h2 class="h6 mb-3">SLA por mecánico (≤ {{ sla_objetivo }} h)</h2>
            <table class="table table-sm align-middle mb-0">
              <thead>
                <tr>
                  <th>Mecánico</th>
                  <th class="text-end">Cerradas</th>
                  <th class="text-end">Dentro SLA</th>
                  <th class="text-end">Cumplimiento</th>
                </tr>
              </thead>
              <tbody>
                {% for user, t, d, p in sla_mecanicos %}
                  <tr>
                    <td>{{ user }}</td>
                    <td class="text-end">{{ t }}</td>
                    <td class="text-end">{{ d }}</td>
                    <td class="text-end">
                      <span class="badge {% if p >= 90 %}text-bg-success{% elif p >= 70 %}text-bg-warning{% else %}text-bg-danger{% endif %}">
                        {{ p }}%
                      </span>
                    </td>
                  </tr>
                {% empty %}
                  <tr><td colspan="4" class="text-muted">Sin datos.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        <!-- === Sección: OTs filtradas === -->
        <div class="row g-4 mt-3">
        <div class="col-12">
            <div class="card shadow-sm w-100">
            <div class="card-header py-2">
                <strong>OTs filtradas ({{ ots_page.paginator.count|intcomma }})</strong>
            </div>

            <div class="card-body p-0">
                <div class="table-responsive">  {# evita que el contenido “empuje” el borde #}
                <table class="table table-sm align-middle mb-0">
                    <thead class="table-light">
                    <tr>
                        <th>Folio</th>
                        <th>Patente</th>
                        <th>Estado</th>
                        <th>Taller</th>
                        <th>Ingreso</th>
                        <th>Cierre</th>
                        <th>Activa</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for ot in ots_page %}
                        <tr>
                        <td class="text-nowrap">
                          {% if ot.id in ots_vencidas_ids %}
                            <span class="badge rounded-pill text-bg-danger me-1">SLA</span>
                          {% endif %}
                          {{ ot.folio }}
                        </td>
                        <td class="text-nowrap">{{ ot.vehiculo.patente }}</td>
                        <td>{{ ot.get_estado_actual_display }}</td>
                        <td>{{ ot.taller.nombre }}</td>
                        <td class="text-nowrap">{{ ot.fecha_ingreso|date:"d-m-Y H:i" }}</td>
                        <td class="text-nowrap">{% if ot.fecha_cierre %}{{ ot.fecha_cierre|date:"d-m-Y H:i" }}{% else %}—{% endif %}</td>
                        <td>
                            {% if ot.activa %}
                            <span class="badge text-bg-success">Sí</span>
                            {% else %}
                            <span class="badge text-bg-secondary">No</span>
                            {% endif %}
                        </td>
                        </tr>
                    {% empty %}
                        <tr><td colspan="7" class="text-muted">Sin OTs para los filtros seleccionados.</td></tr>
                    {% endfor %}
                    </tbody>
                </table>
                </div>
            </div>

            {% if ots_page.paginator.num_pages > 1 %}
            <div class="card-footer py-2">
                <nav>
                <ul class="pagination pagination-sm mb-0">
                    {% if ots_page.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?{{ request.GET.urlencode|cut:'page_r='|cut:'page_v='|cut:'page_o=' }}&page_o={{ ots_page.previous_page_number }}">«</a>
                    </li>
                    {% endif %}
                    <li class="page-item disabled">
                    <span class="page-link">Página {{ ots_page.number }} de {{ ots_page.paginator.num_pages }}</span>
                    </li>
                    {% if ots_page.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?{{ request.GET.urlencode|cut:'page_r='|cut:'page_v='|cut:'page_o=' }}&page_o={{ ots_page.next_page_number }}">»</a>
                    </li>
                    {% endif %}
                </ul>
                </nav>
            </div>
            {% endif %}
            </div>
        </div>
        </div>
    </div>

</div>

<!-- Script: autocompletar fechas al cambiar el rango rápido -->
<script>
document.getElementById('filtro-rango')?.addEventListener('change', function () {
  const rango = this.value;
  const fini = document.querySelector('input[name="fini"]');
  const ffin = document.querySelector('input[name="ffin"]');
  const d = new Date();
  function fmt(x){ return x.toISOString().slice(0,10); }

  if (!fini || !ffin) return;

  if (rango === 'hoy') {
    const t = fmt(d);
    fini.value = t; ffin.value = t;
  } else if (rango === 'ult7') {
    const d2 = new Date(d); d2.setDate(d.getDate() - 6);
    fini.value = fmt(d2); ffin.value = fmt(d);
  } else if (rango === 'mes') {
    const d2 = new Date(d.getFullYear(), d.getMonth(), 1);
    fini.value = fmt(d2); ffin.value = fmt(d);
  } else {
    // personalizado: limpia las fechas
    fini.value = ""; ffin.value = "";
  }
});
</script>

{% endblock %}
